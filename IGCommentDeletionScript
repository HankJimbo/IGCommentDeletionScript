/**
 * Instagram Comment Auto-Deletion Script (infinite loop version)
 * - Runs until you stop it manually
 * - Handles "OK" error dialog and resumes
 * - Uses <span>Select</span> detection instead of guessing buttons
 */

;(async function () {
  const DELETION_BATCH_SIZE = 12
  const DELAY_BETWEEN_ACTIONS_MS = 1500
  const DELAY_BETWEEN_CHECKBOX_CLICKS_MS = 300
  const DELAY_AFTER_SELECT_CLICK_MS = 8000
  const DELAY_AFTER_COMMENTS_VISIBLE_MS = 2000
  const MAX_RETRIES = 60

  const delay = (ms) => new Promise((resolve) => setTimeout(resolve, ms))

  const waitForElement = async (selector, timeout = 30000) => {
    const startTime = Date.now()
    while (Date.now() - startTime < timeout) {
      const element = document.querySelector(selector)
      if (element) return element
      await delay(100)
    }
    throw new Error(`Element with selector "${selector}" not found within ${timeout}ms`)
  }

  const clickElement = async (element) => {
    if (!element) throw new Error('Element not found')
    element.scrollIntoView({ behavior: 'smooth', block: 'center' })
    element.click()
  }

  // Find the "Select" control via its <span>Select</span>
  const getSelectControl = () => {
    const spans = Array.from(document.querySelectorAll('span'))
    const selectSpan = spans.find(
      (el) =>
        el.textContent.trim() === 'Select' &&
        el.getAttribute('data-bloks-name') === 'bk.components.Text'
    )

    if (!selectSpan) return null
    // Prefer a clickable ancestor, fall back to the span itself
    return selectSpan.closest('button, [role="button"]') || selectSpan
  }

  const waitForSelectButton = async () => {
    for (let i = 0; i < MAX_RETRIES; i++) {
      const selectControl = getSelectControl()
      if (selectControl) return selectControl
      await delay(500)
    }
    throw new Error('Select button not found after maximum retries')
  }

  // Click the "OK" dialog and log it, if present
  const clickOkIfPresent = async () => {
    const okCandidates = Array.from(
      document.querySelectorAll('div, span, button')
    ).filter((el) => el.textContent.trim() === 'OK')

    if (okCandidates.length > 0) {
      try {
        console.log('❌ Failed to delete — OK dialog appeared')
        await clickElement(okCandidates[0])
        await delay(1000)
        return true
      } catch (e) {
        console.warn('⚠️ Detected OK dialog but clicking failed:', e.message)
      }
    }
    return false
  }

  const deleteSelectedComments = async () => {
    try {
      // Find the "Delete" control (span with text Delete/Löschen)
      const deleteButton = Array.from(document.querySelectorAll('span'))
        .find(el => ['Delete', 'Löschen'].includes(el.textContent.trim()))

      if (!deleteButton) throw new Error('Delete button not found')
      await clickElement(deleteButton)
      await delay(DELAY_BETWEEN_ACTIONS_MS)

      // If Instagram pops the "Something went wrong → OK" dialog:
      if (await clickOkIfPresent()) {
        // Abort this deletion attempt; outer loop will continue
        return
      }

      // Normal case: a confirmation button is shown
      const confirmButton = await waitForElement('button[tabindex="0"]')
      await clickElement(confirmButton)
    } catch (error) {
      console.error('Error during comment deletion:', error.message)
      // Try to clear any OK dialog and move on
      await clickOkIfPresent()
    }
  }

  const scrollAndWaitForMoreComments = async (previousCount) => {
    window.scrollTo(0, document.body.scrollHeight)
    for (let i = 0; i < 10; i++) {
      await delay(1000)
      const currentCount = document.querySelectorAll('[aria-label="Toggle checkbox"]').length
      if (currentCount > previousCount) return true
    }
    return false
  }

  const deleteActivity = async () => {
    try {
      while (true) {
        // Small breather to avoid pegging CPU
        await delay(500)

        // Clear any stray OK dialog first
        await clickOkIfPresent()

        const selectButton = await waitForSelectButton()
        if (!selectButton) throw new Error('Select button not found')

        await clickElement(selectButton)
        await delay(DELAY_AFTER_SELECT_CLICK_MS)

        let checkboxes = document.querySelectorAll('[aria-label="Toggle checkbox"]')
        if (checkboxes.length === 0) {
          // No "no more comments" break —
